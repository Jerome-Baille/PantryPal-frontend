<div class="profile-container">
  <!-- First row: Language Settings and Logout Section side by side -->
  <div class="bento-row">
    <!-- Language Settings Card -->
    <mat-card class="language-settings bento-item">
      <mat-card-header>
        <span class="material-symbols-outlined" mat-card-avatar>language</span>
        <mat-card-title>
          {{ 'LANGUAGE' | translate }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-button-toggle-group [value]="currentLang" (change)="switchLanguage($event.value)">
          <mat-button-toggle value="en">English</mat-button-toggle>
          <mat-button-toggle value="fr">Fran√ßais</mat-button-toggle>
        </mat-button-toggle-group>
      </mat-card-content>
    </mat-card>

    <!-- Logout Section -->
    <mat-card class="logout-section bento-item">
      <mat-card-header>
        <span class="material-symbols-outlined" mat-card-avatar>exit_to_app</span>
        <mat-card-title>{{ 'ACCOUNT' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="account-actions">
          <button mat-raised-button color="primary" routerLink="/favorites">
            <span class="material-symbols-outlined">favorite</span>
            {{ 'FAVORITES' | translate }}
          </button>

          <button mat-raised-button color="warn" (click)="onLogout()">
            <span class="material-symbols-outlined">logout</span>
            {{ 'LOGOUT' | translate }}
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Second row: Share Settings and Share Links side by side -->
  <div class="bento-row">
    <!-- Share Settings Card -->
    <mat-card class="share-settings bento-item">
      <mat-card-header>
        <span class="material-symbols-outlined" mat-card-avatar>settings</span>
        <mat-card-title>{{ 'SHARE_SETTINGS' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="shareForm" (ngSubmit)="createShareLink()">
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>{{ 'PERMISSION_LEVEL' | translate }}</mat-label>
            <mat-select formControlName="permissionLevel" id="share-permission-level">
              <mat-option value="read">{{ 'READ_ONLY' | translate }}</mat-option>
              <mat-option value="edit">{{ 'READ_WRITE' | translate }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field class="full-width" appearance="outline">
            <mat-label>{{ 'EXPIRES_IN_DAYS' | translate }}</mat-label>
            <input matInput type="number" formControlName="expiresInDays" min="1" max="30" id="share-expires-in-days">
          </mat-form-field>

          <button mat-raised-button color="primary" type="submit">
            <span class="material-symbols-outlined">link</span>
            {{ 'CREATE_SHARE_LINK' | translate }}
          </button>
        </form>

        @if (shareUrl) {
          <div class="share-url-container">
            <mat-form-field class="full-width" appearance="outline">
              <mat-label>{{ 'SHARE_URL' | translate }}</mat-label>
              <input matInput [value]="shareUrl" readonly id="share-url">
              <button matSuffix mat-icon-button (click)="copyShareUrl()" matTooltip="{{ 'COPY_TO_CLIPBOARD' | translate }}">
                  <span class="material-symbols-outlined">content_copy</span>
              </button>
            </mat-form-field>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Share Links Section -->
    <mat-card class="share-links-section bento-item">
      <mat-card-header>
        <span class="material-symbols-outlined" mat-card-avatar>link</span>
        <mat-card-title>{{ 'SHARE_LINKS' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="share-links-header">
          <div class="toggle-container">
            <mat-slide-toggle [(ngModel)]="showAllLinks" (change)="loadShareLinks()">
              {{ 'SHOW_ALL_LINKS' | translate }}
            </mat-slide-toggle>
          </div>

          <!-- New: Bulk management options -->
          @if (shareStats && showAllLinks) {
            <div class="bulk-actions">
              <button mat-icon-button [matMenuTriggerFor]="bulkMenu" [disabled]="isDeletingAllLinks" class="bulk-actions-button">
                <span class="material-symbols-outlined">more_vert</span>
              </button>
              <mat-menu #bulkMenu="matMenu">
                @if (shareStats.expired > 0) {
                  <button mat-menu-item (click)="bulkDeleteShareLinks('expired')">
                    <span class="material-symbols-outlined">auto_delete</span>
                    {{ 'DELETE_EXPIRED_LINKS' | translate }} ({{shareStats.expired}})
                  </button>
                }
                @if (shareStats.used > 0) {
                  <button mat-menu-item (click)="bulkDeleteShareLinks('used')">
                    <span class="material-symbols-outlined">delete_forever</span>
                    {{ 'DELETE_USED_LINKS' | translate }} ({{shareStats.used}})
                  </button>
                }
                @if (shareStats.accepted > 0) {
                  <button mat-menu-item (click)="bulkDeleteShareLinks('accepted')">
                    <span class="material-symbols-outlined">delete_outline</span>
                    {{ 'DELETE_ACCEPTED_LINKS' | translate }} ({{shareStats.accepted}})
                  </button>
                }
              </mat-menu>
            </div>
          }
        </div>

        <div class="share-links-list">
          @if (shareLinks.length === 0) {
            <div class="no-links-message">
              {{ 'NO_SHARE_LINKS' | translate }}
            </div>
          }

          @for (link of shareLinks; track link.token) {
            <mat-card class="share-link-item">
              <div class="link-header">
                <div class="link-title">
                  @if (link.type === 'recipe') {
                    <span class="recipe-title">{{ link.recipe?.title }}</span>
                  }
                  @if (link.type === 'global') {
                    <span class="all-recipes">{{ 'ALL_RECIPES' | translate }}</span>
                  }
                </div>
                <div class="link-status">
                  <span [class]="'status-badge ' + link.status">{{ link.status | uppercase }}</span>
                </div>
              </div>
              <div class="link-content">
                <div class="link-permissions">
                  <span class="material-symbols-outlined">{{ link.permissionLevel === 'read' ? 'visibility' : 'edit' }}</span>
                  <span>{{ (link.permissionLevel === 'read' ? 'READ_ONLY' : 'READ_WRITE') | translate }}</span>
                </div>
                <div class="link-expiry">
                  <span class="material-symbols-outlined">schedule</span>
                  <span>{{ 'EXPIRES_AT' | translate }}: {{ link.expiresAt | date:'short' }}</span>
                </div>
              </div>
              <div class="link-actions">
                <button mat-stroked-button (click)="copyShareUrl(link.shareUrl)" color="primary">
                  <span class="material-symbols-outlined">content_copy</span>
                  {{ 'COPY_LINK' | translate }}
                </button>
                <!-- New: Delete button -->
                <button mat-stroked-button color="warn" (click)="deleteShareLink(link)" [disabled]="isDeletingLink">
                  <span class="material-symbols-outlined">delete</span>
                  {{ 'DELETE' | translate }}
                </button>
              </div>
            </mat-card>
          }
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Third row: Sharing Users Section (full width) -->
  <div class="bento-row full-width">
    <!-- Sharing Users Section - Using the new component -->
    <mat-card class="sharing-users-section bento-item">
      <mat-card-header>
        <span class="material-symbols-outlined" mat-card-avatar>people</span>
        <mat-card-title>{{ 'SHARING_USERS' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <app-sharing-users></app-sharing-users>
      </mat-card-content>
    </mat-card>
  </div>
</div>