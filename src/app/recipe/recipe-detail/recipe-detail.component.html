@if (!error && recipe?.id) {
  <div class="main-container">
    <mat-card class="section-card">
      <div class="option-buttons">
        <button class="favorite-button" [class.favorite]="isFavorite" [class.favorite-animation]="isFavorite"
          (click)="toggleFavorite()" mat-icon-button>
          <mat-icon class="heart-icon">favorite</mat-icon>
        </button>
        <mat-card-title class="card-title">{{ recipe?.title }}</mat-card-title>
        <app-share-options [recipe]="recipe"></app-share-options>
      </div>
      @if (recipe?.typeOfMeal) {
        <mat-card-subtitle class="card-subtitle">
          [ {{ recipe?.typeOfMeal }} ]
        </mat-card-subtitle>
      }
      <mat-card-subtitle class="card-subtitle">
        <span class="book-title">{{ recipe?.Book?.title }} </span> {{ 'BY' | translate }} {{ recipe?.Book?.author }}
      </mat-card-subtitle>
      <!-- Recipe Image Display -->
      @if (recipe?.picture || recipe?.thumbnail) {
        <div class="image-wrapper">
          <div class="recipe-image-container">
            <picture>
              <source [srcset]="recipe.picture" media="(min-width: 768px)">
              <img [src]="recipe.thumbnail || recipe.picture" [alt]="recipe.title" class="recipe-image">
            </picture>
          </div>
        </div>
      }
      <mat-card-content class="card-content">
        <!-- Timers Section -->
        <mat-card class="section-card">
          <mat-card-header>
            <mat-card-title>{{ 'TIMERS_SECTION' | translate }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="time-container">
              @for (element of recipeTime; track element; let i = $index) {
                @if (!element.showTimer) {
                  <mat-card (click)="toggleTimer(element)">
                    <mat-card-title>{{ getTranslatedTimerName(element.name) | translate
                    }}</mat-card-title>
                    <mat-card-content>
                      {{ formatTime(element.time) }}
                    </mat-card-content>
                  </mat-card>
                }
                @if (element.showTimer) {
                  <div class="timer-container">
                    <app-timer [timerInfo]="createTimerState(element)"></app-timer>
                    <button mat-icon-button class="timer-button" (click)="toggleTimer(element)">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                }
              }
            </div>
          </mat-card-content>
        </mat-card>
        <!-- Ingredients Section -->
        <mat-card class="section-card">
          <mat-card-header>
            <mat-card-title>{{ 'INGREDIENTS' | translate }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="ingredients-header">
              @if (recipe?.servings) {
                <div class="servings-selector">
                  {{ 'SERVINGS' | translate }}:
                  <mat-select [value]="servingsMultiplier" (selectionChange)="onServingsChange($event.value)"
                    class="compact-select" id="servings-multiplier">
                    @for (mult of availableServings; track mult) {
                      <mat-option [value]="mult">
                        {{ recipe.servings * mult }}
                      </mat-option>
                    }
                  </mat-select>
                </div>
              }
              <app-add-to-shopping-list [recipe]="recipe"
              [multiplier]="servingsMultiplier"></app-add-to-shopping-list>
            </div>
            <div class="ingredients-grid">
              @for (group of groupedIngredients; track group) {
                <div class="ingredient-section">
                  @if (group.section) {
                    <h3 class="section-title">{{ group.section }}</h3>
                  }
                  <ul>
                    @for (ingredient of group.ingredients; track ingredient) {
                      <li>
                        {{ ingredient?.Ingredient?.name }}{{ ((ingredient?.Ingredient?.name?.toLowerCase()
                        === 'sel' || ingredient?.Ingredient?.name?.toLowerCase() === 'poivre') &&
                        ingredient.unit?.toLowerCase() === 'unit') ? '' : ' - ' +
                        (ingredient.adjustedQuantity | number:'1.0-2') + (ingredient.unit?.toLowerCase() !==
                        'unit' ? ' ' + (translateUnit(ingredient.unit) | translate) : '') }}
                      </li>
                    }
                  </ul>
                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>
        <!-- Instructions Section -->
        <mat-card class="section-card">
          <mat-card-header>
            <div class="instructions-header">
              <mat-card-title>{{ 'INSTRUCTIONS_SECTION' | translate }}</mat-card-title>
              <div class="instructions-actions">
                @if (completedStepsCount > 0) {
                  <span class="progress-indicator">
                    {{ completedStepsCount }} / {{ totalSteps }} {{ 'STEPS_COMPLETED' | translate }}
                  </span>
                }
                <button 
                  mat-raised-button 
                  color="primary" 
                  (click)="openGuidedMode()"
                  class="guided-mode-button"
                  [matTooltip]="'START_GUIDED_MODE' | translate">
                  <mat-icon>play_circle_outline</mat-icon>
                  {{ 'GUIDED_MODE' | translate }}
                </button>
              </div>
            </div>
          </mat-card-header>
          <mat-card-content>
            @for (instruction of isolatedInstructions; track instruction; let i = $index; let last = $last) {
              <div class="instruction-item" [class.completed]="isStepCompleted(i)">
                <button 
                  class="step-checkbox"
                  (click)="toggleStepCompletion(i)"
                  [attr.aria-label]="(isStepCompleted(i) ? 'MARK_INCOMPLETE' : 'MARK_COMPLETE') | translate"
                  [attr.aria-pressed]="isStepCompleted(i)"
                  mat-icon-button>
                  <mat-icon>{{ isStepCompleted(i) ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                </button>
                <p class="instruction-text" [class.completed-text]="isStepCompleted(i)">
                  {{ instruction }}
                </p>
              </div>
              @if (!last) {
                <mat-divider></mat-divider>
              }
            }
            @if (completedStepsCount > 0) {
              <div class="clear-progress">
                <button 
                  mat-stroked-button 
                  (click)="clearCompletedSteps()"
                  class="clear-button">
                  <mat-icon>restart_alt</mat-icon>
                  {{ 'CLEAR' | translate }}
                </button>
              </div>
            }
          </mat-card-content>
        </mat-card>
        <!-- Notes Section -->
        @if (recipe?.notes) {
          <mat-card class="section-card">
            <mat-card-header>
              <mat-card-title>{{ 'NOTES_SECTION' | translate }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <p class="instructions">{{ recipe?.notes }}</p>
            </mat-card-content>
          </mat-card>
        }
        <div class="card-button">
          <button mat-raised-button color="primary" routerLink="/recipe/update/{{ recipe?.id }}">
            {{ 'RECIPE_UPDATE' | translate }}
          </button>
          <button mat-raised-button class="btn-color-accent" (click)="deleteRecipe()">
            {{ 'DELETE' | translate }}
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
}